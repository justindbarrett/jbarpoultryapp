<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-button (click)="cancel()">Cancel</ion-button>
    </ion-buttons>
    <ion-title>Lot Details</ion-title>
    <ion-buttons slot="end" *ngIf="userRole !== 'inspector'">
      <ion-button color="primary" (click)="save()">Save</ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <div *ngIf="loading" class="loading-container">
    <ion-spinner></ion-spinner>
    <p>Loading lot data...</p>
  </div>

  <div *ngIf="!loading && lot; else noLot">
    <!-- Top Row: Lot and Customer Info Side by Side -->
    <ion-grid class="top-info-grid">
      <ion-row>
        <ion-col size="12" size-md="6">
          <ion-card>
            <ion-card-header>
              <ion-card-title>Lot Information</ion-card-title>
            </ion-card-header>
            <ion-card-content>
              <ion-grid class="compact-grid">
                <ion-row>
                  <ion-col size="6">
                    <div class="info-field">
                      <strong>Lot Number:</strong>
                      <p>{{ lot.lotNumber }}</p>
                    </div>
                  </ion-col>
                  <ion-col size="6">
                    <div class="info-field">
                      <strong>Process Date:</strong>
                      <p>{{ lot.processDate }}</p>
                    </div>
                  </ion-col>
                </ion-row>
              </ion-grid>
            </ion-card-content>
          </ion-card>
        </ion-col>

        <ion-col size="12" size-md="6">
          <ion-card *ngIf="lot.customer">
            <ion-card-header>
              <ion-card-title>Customer Information</ion-card-title>
            </ion-card-header>
            <ion-card-content>
              <ion-grid class="compact-grid">
                <ion-row>
                  <ion-col size="4">
                    <div class="info-field">
                      <strong>Name:</strong>
                      <p>{{ lot.customer.name }}</p>
                    </div>
                  </ion-col>
                  <ion-col size="4">
                    <div class="info-field">
                      <strong>Phone:</strong>
                      <p>{{ lot.customer.phone }}</p>
                    </div>
                  </ion-col>
                  <ion-col size="4">
                    <div class="info-field">
                      <strong>Address:</strong>
                      <p>{{ lot.customer.address }}</p>
                    </div>
                  </ion-col>
                </ion-row>
              </ion-grid>
            </ion-card-content>
          </ion-card>
        </ion-col>
      </ion-row>
    </ion-grid>

    <!-- Processing Instructions Card -->
    <ion-card>
      <ion-card-header>
        <ion-card-title>Processing Instructions</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-grid>
          <ion-row>
            <ion-col size="6" size-md="2">
              <ion-item lines="none">
                <ion-label position="stacked">Whole Birds</ion-label>
                <ion-input
                  type="number"
                  [(ngModel)]="lot.processingInstructions.wholeBirds"
                  [readonly]="!canEditProcessingInstructions()"
                ></ion-input>
              </ion-item>
            </ion-col>
            <ion-col size="6" size-md="2">
              <ion-item lines="none">
                <ion-label position="stacked">Cut Up Birds</ion-label>
                <ion-input
                  type="number"
                  [(ngModel)]="lot.processingInstructions.cutUpBirds"
                  [readonly]="!canEditProcessingInstructions()"
                ></ion-input>
              </ion-item>
            </ion-col>
            <ion-col size="6" size-md="2">
              <ion-item lines="none">
                <ion-label position="stacked">Halves</ion-label>
                <ion-input
                  type="number"
                  [(ngModel)]="lot.processingInstructions.halves"
                  [readonly]="!canEditProcessingInstructions()"
                ></ion-input>
              </ion-item>
            </ion-col>
            <ion-col size="6" size-md="2">
              <ion-item lines="none">
                <ion-label position="stacked">6-Piece (leg quarters)</ion-label>
                <ion-input
                  type="number"
                  [(ngModel)]="lot.processingInstructions.sixPiece"
                  [readonly]="!canEditProcessingInstructions()"
                ></ion-input>
              </ion-item>
            </ion-col>
            <ion-col size="6" size-md="2">
              <ion-item lines="none">
                <ion-label position="stacked">8-Piece (thighs drums)</ion-label>
                <ion-input
                  type="number"
                  [(ngModel)]="lot.processingInstructions.eightPiece"
                  [readonly]="!canEditProcessingInstructions()"
                ></ion-input>
              </ion-item>
            </ion-col>
            <ion-col size="6" size-md="2">
              <ion-item lines="none">
                <ion-select
                  label="Extras to Save"
                  labelPlacement="stacked"
                  [(ngModel)]="lot.processingInstructions.extrasToSave"
                  multiple="true"
                  [disabled]="!canEditProcessingInstructions()"
                >
                  <ion-select-option value="neck">Neck</ion-select-option>
                  <ion-select-option value="heart">Heart</ion-select-option>
                  <ion-select-option value="feet">Feet</ion-select-option>
                  <ion-select-option value="liver">Liver</ion-select-option>
                </ion-select>
              </ion-item>
            </ion-col>
          </ion-row>
          <ion-row>
            <ion-col size="12">
              <ion-item lines="none">
                <ion-label position="stacked">Notes</ion-label>
                <ion-textarea
                  rows="2"
                  [(ngModel)]="lot.processingInstructions.notes"
                  placeholder="Additional processing notes..."
                  [readonly]="!canEditProcessingInstructions()"
                ></ion-textarea>
              </ion-item>
            </ion-col>
          </ion-row>
        </ion-grid>
      </ion-card-content>
    </ion-card>

    <!-- Lot Details Card -->
    <ion-card>
      <ion-card-header>
        <ion-card-title>Check-In Details</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-grid>
          <ion-row>
            <ion-col size="6" size-md="2">
              <ion-item lines="none">
                <ion-select
                  label="Species"
                  labelPlacement="stacked"
                  [(ngModel)]="lot.species"
                  interface="popover"
                  [disabled]="!canEditCheckInDetails()"
                >
                  <ion-select-option
                    *ngFor="let type of poultryTypes"
                    [value]="type"
                    >{{ type }}</ion-select-option
                  >
                </ion-select>
              </ion-item>
            </ion-col>
            <ion-col size="6" size-md="2">
              <div class="toggle-field">
                <div class="toggle-label">
                  <strong>Withdrawal Time Met?</strong>
                  <ion-icon
                    name="information-circle-outline"
                    (click)="showWithdrawalInfo()"
                  ></ion-icon>
                </div>
                <ion-toggle
                  [(ngModel)]="lot.withdrawalMet"
                  [disabled]="!canEditCheckInDetails()"
                ></ion-toggle>
              </div>
            </ion-col>
            <ion-col size="6" size-md="2">
              <div class="toggle-field">
                <div class="toggle-label">
                  <strong>Organic?</strong>
                  <ion-icon
                    name="information-circle-outline"
                    (click)="showOrganicInfo()"
                  ></ion-icon>
                </div>
                <ion-toggle
                  [(ngModel)]="lot.isOrganic"
                  [disabled]="!canEditCheckInDetails()"
                ></ion-toggle>
              </div>
            </ion-col>
            <ion-col size="6" size-md="2">
              <ion-item lines="none">
                <ion-label position="stacked">Customer Count</ion-label>
                <ion-input
                  type="number"
                  [(ngModel)]="lot.customerCount"
                  [readonly]="!canEditCheckInDetails()"
                ></ion-input>
              </ion-item>
            </ion-col>
            <ion-col size="6" size-md="2">
              <ion-item lines="none">
                <ion-label position="stacked">Final Count</ion-label>
                <ion-input
                  type="number"
                  [(ngModel)]="lot.finalCount"
                  [readonly]="!canEditCheckInDetails()"
                ></ion-input>
              </ion-item>
            </ion-col>
            <!-- Customer Initial Column - Service/Admin -->
            <ion-col size="6" size-md="2" *ngIf="userRole !== 'inspector'">
              <!-- Customer Initial - Always show first -->
              <ion-item lines="none" *ngIf="!lot.customerInitial">
                <app-customer-initial-button
                  buttonText="Customer Initial"
                  buttonColor="tertiary"
                  buttonExpand="block"
                  [customerInitial]="lot.customerInitial"
                  [timeIn]="lot.timeIn"
                  (confirmed)="onCustomerInitialConfirmed($event)"
                ></app-customer-initial-button>
              </ion-item>
              <ion-item lines="none" *ngIf="lot.customerInitial">
                <ion-label position="stacked"
                  >Time In / Customer Initial</ion-label
                >
                <app-customer-initial-button
                  buttonText="Customer Initial"
                  buttonColor="tertiary"
                  buttonExpand="block"
                  [customerInitial]="lot.customerInitial"
                  [timeIn]="lot.timeIn"
                  (confirmed)="onCustomerInitialConfirmed($event)"
                ></app-customer-initial-button>
              </ion-item>
            </ion-col>
            <!-- Customer Initial Column - Inspector -->
            <ion-col size="6" size-md="2" *ngIf="userRole === 'inspector'">
              <!-- Show "Customer Initials Needed" when no initials exist -->
              <ion-item lines="none" *ngIf="!lot.customerInitial">
                <div style="padding-top: 8px">
                  <ion-text style="color: #999; font-style: italic">
                    Customer Initials Needed
                  </ion-text>
                </div>
              </ion-item>
              <!-- Show initials and time when they exist -->
              <ion-item lines="none" *ngIf="lot.customerInitial">
                <ion-label position="stacked"
                  >Time In / Customer Initial</ion-label
                >
                <div
                  style="
                    padding-top: 8px;
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    flex-wrap: wrap;
                  "
                >
                  <ion-text style="font-size: 1em; color: #666">
                    {{ formattedTimeIn }}
                  </ion-text>
                  <ion-text style="font-size: 1.1em">
                    <strong>{{ lot.customerInitial }}</strong>
                  </ion-text>
                </div>
              </ion-item>
            </ion-col>
            <!-- FSIS Initial after customer initial is entered (Service/Admin) -->
            <ion-col
              size="6"
              size-md="2"
              *ngIf="lot.customerInitial && userRole !== 'inspector'"
            >
              <!-- When no initials exist yet -->
              <ion-item lines="none" *ngIf="!lot.fsisInitial">
                <app-fsis-initial-button
                  buttonText="Ante Mortem FSIS Initial"
                  buttonColor="secondary"
                  buttonExpand="block"
                  [fsisInitial]="lot.fsisInitial"
                  [anteMortemTime]="lot.anteMortemTime"
                  (confirmed)="onFsisConfirmed($event)"
                ></app-fsis-initial-button>
              </ion-item>
              <!-- When initials exist -->
              <ion-item lines="none" *ngIf="lot.fsisInitial">
                <ion-label position="stacked">Ante Mortem / FSIS</ion-label>
                <app-fsis-initial-button
                  buttonText="Ante Mortem FSIS Initial"
                  buttonColor="secondary"
                  buttonExpand="block"
                  [fsisInitial]="lot.fsisInitial"
                  [anteMortemTime]="lot.anteMortemTime"
                  (confirmed)="onFsisConfirmed($event)"
                ></app-fsis-initial-button>
              </ion-item>
            </ion-col>
            <!-- FSIS Initial for Inspector (only after customer initial) -->
            <ion-col
              size="6"
              size-md="2"
              *ngIf="lot.customerInitial && userRole === 'inspector'"
            >
              <!-- When no initials exist yet -->
              <ion-item lines="none" *ngIf="!lot.fsisInitial">
                <app-fsis-initial-button
                  buttonText="Ante Mortem FSIS Initial"
                  buttonColor="secondary"
                  buttonExpand="block"
                  [fsisInitial]="lot.fsisInitial"
                  [anteMortemTime]="lot.anteMortemTime"
                  (confirmed)="onFsisConfirmed($event)"
                ></app-fsis-initial-button>
              </ion-item>
              <!-- When initials exist -->
              <ion-item lines="none" *ngIf="lot.fsisInitial">
                <ion-label position="stacked">Ante Mortem / FSIS</ion-label>
                <app-fsis-initial-button
                  buttonText="Ante Mortem FSIS Initial"
                  buttonColor="secondary"
                  buttonExpand="block"
                  [fsisInitial]="lot.fsisInitial"
                  [anteMortemTime]="lot.anteMortemTime"
                  (confirmed)="onFsisConfirmed($event)"
                ></app-fsis-initial-button>
              </ion-item>
            </ion-col>
          </ion-row>
        </ion-grid>
      </ion-card-content>
    </ion-card>
  </div>

  <ng-template #noLot>
    <p>No lot data available.</p>
  </ng-template>
</ion-content>
